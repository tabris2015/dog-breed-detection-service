{% extends 'detection/base.html' %}
{% load bootstrap4 %}
{% block content %}
    <h1>Hola bola</h1>
    <div id="container">
        <video autoplay="true" id="videoElement">

        </video>
    </div>
    <button id="send_button" type="button" class="btn btn-primary" onclick="sendImage()">Detect</button>
    <h2>Animal:</h2>
    <h3 id="animal">-</h3>
    <h2>Raza:</h2>
    <h3 id="raza">-</h3>
    <h3 id="top1">-</h3>
    <h3 id="top2">-</h3>
    <h3 id="top3">-</h3>
    <canvas id="c" style="display:none;" width="300" height="300"></canvas>
<script>

    var video = document.querySelector("#videoElement");

    if (navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({video: true})
            .then(function (stream) {
                video.srcObject = stream;
            })
            .catch(function (err0r) {
                console.log("Something went wrong!");
            });
    }

    function sendImage(){
        var canvas = document.getElementById("c");
        var video = document.getElementById("videoElement");
        // capturar cuadrado
        canvas.getContext("2d").drawImage(video, 0, 0, video.videoHeight, video.videoHeight, 0, 0, 300, 300);
        var img = canvas.toDataURL("image/png");
        console.log('enviando imagen!');
        let data = {image: img};

        fetch("/image/", {
            method: "POST",
            body: JSON.stringify(data)
        }).then(res => {
            res.json().then(json => {
                    console.log('prediccion:', json);
                    document.getElementById("animal").innerHTML = json["animal"];
                    document.getElementById("raza").innerHTML = json["raza"]["main"];
                    document.getElementById("top1").innerHTML = json["raza"]["1"];
                    document.getElementById("top2").innerHTML = json["raza"]["2"];
                    document.getElementById("top3").innerHTML = json["raza"]["3"];
                }
            );
        });
        //var dataURL = document.getElementById('videoElement').toDataURL("image/png");
        //document.getElementById('id_hidden_image_field').value = dataURL;
    }
</script>
{% endblock %}

